CVE-2020-27821 patch adapted from QEMU 5.2 patch by Paolo Bonzini

Link: https://bugzilla.redhat.com/show_bug.cgi?id=1902651

Signed-off-by: Nicolas Ontiveros <niontive@microsoft.com>
---
 exec.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/exec.c b/exec.c
index 3027747c03..d2c0010ea0 100644
--- a/exec.c
+++ b/exec.c
@@ -3620,6 +3620,7 @@ int64_t address_space_cache_init(MemoryRegionCache *cache,
     AddressSpaceDispatch *d;
     hwaddr l;
     MemoryRegion *mr;
+    Int128 diff;
 
     assert(len > 0);
 
@@ -3628,6 +3629,8 @@ int64_t address_space_cache_init(MemoryRegionCache *cache,
     d = flatview_to_dispatch(cache->fv);
     cache->mrs = *address_space_translate_internal(d, addr, &cache->xlat, &l, true);
 
+    diff = int128_sub(cache->mrs.size, int128_make64(cache->xlat));
+    l = int128_get64(int128_min(diff, int128_make64(l)));
     mr = cache->mrs.mr;
     memory_region_ref(mr);
     if (memory_access_is_direct(mr, is_write)) {

-- 
2.28.0
