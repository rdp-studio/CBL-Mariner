From f7e13c34bc2f820ff124f1425c5d92dbdaa2e8da Mon Sep 17 00:00:00 2001
From: Leandro Pereira <lpereira@linux.microsoft.com>
Date: Thu, 1 Oct 2020 15:51:32 -0700
Subject: [PATCH] CVE-2020-13342: Do not rely on $PATH to find
 systemd-ask-password

The execlp() call will look at the $PATH environment variable to
determine which binary to execute; if a binary naemd
"systemd-ask-password" is present, that will be called with the same
privileges as "mount.cifs", which could be elevated as that might be
executed under sudo or the executable might be SUID root.  Moreover,
this could be used to exfiltrate the password if somebody has access to
the environment.

This patch makes the call using /usr/bin/systemd-ask-password directly.

Signed-off-by: Leandro Pereira <lpereira@linux.microsoft.com>
---
 mount.cifs.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/mount.cifs.c b/mount.cifs.c
index 4feb397..af0a796 100644
--- a/mount.cifs.c
+++ b/mount.cifs.c
@@ -1669,7 +1669,8 @@ static int get_passwd_by_systemd(const char *prompt, char *input, int capacity)
	if (pid == 0) {
		close(fd[0]);
		dup2(fd[1], STDOUT_FILENO);
-		if (execlp("systemd-ask-password", "systemd-ask-password", prompt, NULL) == -1) {
+		if (execlp("/usr/bin/systemd-ask-password",
+		"/usr/bin/systemd-ask-password", prompt, NULL) == -1) {
			fprintf(stderr, "Failed to execute systemd-ask-password: %s\n",
			strerror(errno));
		}
--
1.8.3.1
